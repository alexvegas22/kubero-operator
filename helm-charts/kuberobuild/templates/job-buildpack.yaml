{{- if eq .Values.buildstrategy "buildpacks" }}
{{- $name := printf "%s-%s-%s" .Values.app .Values.pipeline .Values.id -}}
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    batch.kubernetes.io/job-name: {{ $name }}
    buildstrategy: buildpacks
    kuberoapp: {{ .Values.app }}
    kuberopipeline: {{ .Values.pipeline }}
    job-name: {{ $name }}
  name: {{ $name }}
spec:
  backoffLimit: 1
  completionMode: NonIndexed
  completions: 1
  manualSelector: false
  parallelism: 1
  podReplacementPolicy: TerminatingOrFailed
  suspend: false
  template:
    metadata:
      labels:
        batch.kubernetes.io/job-name: {{ $name }}
        buildstrategy: {{ .Values.buildstrategy }}
        kuberoapp: {{ .Values.app }}
        kuberopipeline: {{ .Values.pipeline }}
        job-name: {{ $name }}
    spec:
      containers:
        - env:
          - name: REPOSITORY
            value: {{ .Values.repository.image }}
          - name: TAG
            value: {{ .Values.repository.tag | default "latest"}}
          - name: APP
            value: {{ .Values.app }}
          command:
          - sh
          - -c
          - 'kubectl patch kuberoapps $APP --type=merge -p "{\"spec\":{\"image\":{\"repository\":
            \"$REPOSITORY\",\"tag\": \"$TAG\"}}}"'
          image: bitnami/kubectl:latest
          imagePullPolicy: Always
          name: deployer
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
      initContainers:
      - image: {{ .Values.buildpack.dispatcher }}
        imagePullPolicy: Always
        name: dispatch
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        env:
        - name: APP
          value: {{ .Values.app }}
        - name: PIPELINE
          value: {{ .Values.pipeline }}
        - name: REPOSITORY
          value: {{ .Values.repository.image }}
        - name: TAG
          value: {{ .Values.repository.tag }}
        - name: SERVICE_ACCOUNT
          value: {{ .Values.buildpack.serviceAccount }}
        - name: BUILDER
          value: {{ .Values.buildpack.builder }}
        - name: GIT_URL
          value: {{ .Values.git.url }}
        - name: GIT_REF
          value: {{ .Values.git.ref }}
        #command:
        #- tail
        #- -f
        #- /dev/null
      dnsPolicy: ClusterFirst
      restartPolicy: Never
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      serviceAccountName: {{ .Values.buildpack.serviceAccount }}
{{- end }}